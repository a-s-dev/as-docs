<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `coop_transaction` mod in crate `places`."><meta name="keywords" content="rust, rustlang, rust-lang, coop_transaction"><title>places::db::tx::coop_transaction - Rust</title><link rel="stylesheet" type="text/css" href="../../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../../dark.css"><link rel="stylesheet" type="text/css" href="../../../../light.css" id="themeStyle"><script src="../../../../storage.js"></script><noscript><link rel="stylesheet" href="../../../../noscript.css"></noscript><link rel="shortcut icon" href="../../../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../../../places/index.html'><div class='logo-container'><img src='../../../../rust-logo.png' alt='logo'></div></a><p class='location'>Module coop_transaction</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></div><p class='location'><a href='../../../index.html'>places</a>::<wbr><a href='../../index.html'>db</a>::<wbr><a href='../index.html'>tx</a></p><script>window.sidebarCurrent = {name: 'coop_transaction', ty: 'mod', relpath: '../'};</script><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../../../settings.html"><img src="../../../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../../../src/places/db/tx/coop_transaction.rs.html#5-234' title='goto source code'>[src]</a></span><span class='in-band'>Module <a href='../../../index.html'>places</a>::<wbr><a href='../../index.html'>db</a>::<wbr><a href='../index.html'>tx</a>::<wbr><a class="mod" href=''>coop_transaction</a></span></h1><div class='docblock'><p>This implements &quot;cooperative transactions&quot; for places. It relies on our
decision to have exactly 1 general purpose &quot;writer&quot; connection and exactly
one &quot;sync writer&quot; - ie, exactly 2 write connections.</p>
<p>We'll describe the implementation and strategy, but note that most callers
should use <code>PlacesDb::begin_transaction()</code>, which will do the right thing
for your db type.</p>
<p>The idea is that anything that uses the sync connection should use
<code>chunked_coop_trransaction</code>. Code using this should regularly call
<code>maybe_commit()</code>, and every second, will commit the transaction and start
a new one.</p>
<p>This means that in theory the other writable connection can start
transactions and should block for a max of 1 second - well under the 5
seconds before that other writer will fail with a SQLITE_BUSY or similar error.</p>
<p>However, in practice we see the writer thread being starved - even though
it's waiting for a lock, the sync thread still manages to re-get the lock.
In other words, the locks used by sqlite aren't &quot;fair&quot;.</p>
<p>So we mitigate this with a simple approach that works fine within our
&quot;exactly 2 writers&quot; constraints:</p>
<ul>
<li>Each database connection shares a mutex.</li>
<li>Before starting a transaction, each connection locks the mutex.</li>
<li>It then starts an &quot;immediate&quot; transaction - because sqlite now holds a
lock on our behalf, we release the lock on the mutex.</li>
</ul>
<p>In other words, the lock is held only while obtaining the DB lock, then
immediately released.</p>
<p>The end result here is that if either connection is waiting for the
database lock because the other already holds it, the waiting one is
guaranteed to get the database lock next.</p>
<p>One additional wrinkle here is that even if there was exactly one writer,
there's still a possibility of SQLITE_BUSY if the database is being
checkpointed. So we handle that case and perform exactly 1 retry.</p>
</div><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.ChunkedCoopTransaction.html" title='places::db::tx::coop_transaction::ChunkedCoopTransaction struct'>ChunkedCoopTransaction</a></td><td class='docblock-short'><p>This transaction is suitable for when a transaction is used purely for
performance reasons rather than for data-integrity reasons, or when it's
used for integrity but held longer than strictly necessary for performance
reasons (ie, when it could be multiple transactions and still guarantee
integrity.) Examples of this might be for performance when updating a larger
number of rows, but data integrity concerns could be addressed by using
multiple, smaller transactions.</p>
</td></tr></table><h2 id='functions' class='section-header'><a href="#functions">Functions</a></h2>
<table><tr class='module-item'><td><a class="fn" href="fn.get_tx_with_retry_on_locked.html" title='places::db::tx::coop_transaction::get_tx_with_retry_on_locked fn'>get_tx_with_retry_on_locked</a></td><td class='docblock-short'></td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../../../";window.currentCrate = "places";</script><script src="../../../../main.js"></script><script defer src="../../../../search-index.js"></script></body></html>